<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FakeCarrier Scanner</title>
    
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 16px;
            background: #f9fafb;
            color: #111827;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .logo {
            max-width: 180px;
            height: auto;
            margin-bottom: 8px;
        }
        
        h1 {
            font-size: 20px;
            margin: 0 0 16px 0;
            color: #111827;
        }
        
        button {
            width: 100%;
            padding: 12px;
            background: #4F46E5;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
            transition: background 150ms;
        }
        
        button:hover {
            background: #4338CA;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .result {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 16px;
        }
        
        .risk-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .risk-low {
            background: #FEF3C7;
            color: #78350F;
            border: 2px solid #FDE68A;
        }
        
        .risk-medium {
            background: #FFEDD5;
            color: #7C2D12;
            border: 2px solid #FED7AA;
        }
        
        .risk-high {
            background: #FEE2E2;
            color: #991B1B;
            border: 2px solid #FECACA;
        }
        
        .score {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 16px;
            color: #111827;
        }
        
        .section {
            margin: 20px 0;
            padding: 16px;
            background: #F9FAFB;
            border-radius: 8px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .issue-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin: 10px 0;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .issue-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            margin-top: 2px;
        }
        
        .recommendation {
            background: white;
            border-left: 3px solid #4F46E5;
            padding: 12px;
            margin: 12px 0;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .recommendation-title {
            font-weight: 600;
            color: #4F46E5;
            margin-bottom: 6px;
        }
        
        .trust-signals {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .trust-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }
        
        .trust-good {
            color: #065F46;
        }
        
        .trust-bad {
            color: #991B1B;
        }
        
        .explanation {
            background: #EEF2FF;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .explanation-title {
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .explanation-text {
            font-size: 13px;
            line-height: 1.6;
            color: #374151;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px;
            font-size: 12px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 150ms;
        }
        
        .btn-delete {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FECACA;
        }
        
        .btn-delete:hover {
            background: #FEF2F2;
        }
        
        .btn-report {
            background: #FFEDD5;
            color: #7C2D12;
            border: 1px solid #FED7AA;
        }
        
        .btn-report:hover {
            background: #FFF7ED;
        }
        
        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 16px;
        }
        
        .loading {
            text-align: center;
            color: #6b7280;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://fakecarriertest.vercel.app/logo-grey.png" alt="FakeCarrier" class="logo">
        </div>
        
        <button id="scanButton" onclick="scanEmail()">Scan This Email</button>
        
        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading" style="display: none;">Scanning email...</div>
        <div id="result" style="display: none;"></div>
    </div>
    
    <script>
        const API_BASE_URL = 'https://fakecarriertest-production.up.railway.app';
        
        Office.onReady((info) => {
            if (info.host === Office.HostType.Outlook) {
                console.log('FakeCarrier add-in loaded');
            }
        });
        
        async function scanEmail() {
            const scanButton = document.getElementById('scanButton');
            const errorDiv = document.getElementById('error');
            const loadingDiv = document.getElementById('loading');
            const resultDiv = document.getElementById('result');
            
            scanButton.disabled = true;
            errorDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            resultDiv.style.display = 'none';
            
            try {
                const item = Office.context.mailbox.item;
                
                // Get sender
                const sender = item.from.emailAddress;
                
                // Get body
                item.body.getAsync(Office.CoercionType.Text, async (bodyResult) => {
                    if (bodyResult.status === Office.AsyncResultStatus.Failed) {
                        showError('Failed to read email body');
                        return;
                    }
                    
                    const body = bodyResult.value;
                    
                    // Get headers (if available)
                    let headers = `From: ${sender}\nSubject: ${item.subject}\n`;
                    
                    // Try to get internet headers (may not be available in all contexts)
                    if (item.getAllInternetHeadersAsync) {
                        item.getAllInternetHeadersAsync((headerResult) => {
                            if (headerResult.status === Office.AsyncResultStatus.Succeeded) {
                                headers = headerResult.value;
                            }
                            performScan(sender, headers, body);
                        });
                    } else {
                        performScan(sender, headers, body);
                    }
                });
            } catch (error) {
                showError('Error reading email: ' + error.message);
                scanButton.disabled = false;
                loadingDiv.style.display = 'none';
            }
        }
        
        async function performScan(sender, headers, body) {
            const scanButton = document.getElementById('scanButton');
            const loadingDiv = document.getElementById('loading');
            
            try {
                const response = await fetch(`${API_BASE_URL}/scan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sender, headers, body })
                });
                
                if (!response.ok) {
                    throw new Error('Scan failed');
                }
                
                const result = await response.json();
                displayResult(result);
            } catch (error) {
                showError('Failed to scan email. Please check your connection.');
            } finally {
                scanButton.disabled = false;
                loadingDiv.style.display = 'none';
            }
        }
        
        function displayResult(result) {
            const resultDiv = document.getElementById('result');
            
            const riskClass = `risk-${result.risk_level}`;
            const riskIcon = result.risk_level === 'high' ? 'üö®' : result.risk_level === 'medium' ? '‚ö†Ô∏è' : '‚ö°';
            
            // Generate recommendations based on risk level
            const recommendations = getRecommendations(result.risk_level);
            
            // Generate plain English explanation
            const explanation = getExplanation(result);
            
            // Separate issues into good and bad signals
            const trustSignals = analyzeTrustSignals(result.summary);
            
            let html = `
                <div class="result">
                    <div class="risk-badge ${riskClass}">
                        ${riskIcon} ${result.risk_level.toUpperCase()} RISK
                    </div>
                    <div class="score">${result.score}/100</div>
                    
                    ${explanation ? `
                        <div class="explanation">
                            <div class="explanation-title">Why is this ${result.risk_level} risk?</div>
                            <div class="explanation-text">${explanation}</div>
                        </div>
                    ` : ''}
                    
                    ${trustSignals.bad.length > 0 ? `
                        <div class="section">
                            <div class="section-title">‚ö†Ô∏è Warning Signs</div>
                            <div class="trust-signals">
                                ${trustSignals.bad.map(item => `
                                    <div class="trust-item trust-bad">
                                        <span class="issue-icon">‚ùå</span>
                                        <span>${item}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${trustSignals.good.length > 0 ? `
                        <div class="section">
                            <div class="section-title">‚úÖ Good Signs</div>
                            <div class="trust-signals">
                                ${trustSignals.good.map(item => `
                                    <div class="trust-item trust-good">
                                        <span class="issue-icon">‚úì</span>
                                        <span>${item}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="recommendation">
                        <div class="recommendation-title">üìã What should you do?</div>
                        ${recommendations}
                    </div>
                    
                    ${result.risk_level !== 'low' ? `
                        <div class="action-buttons">
                            <button class="action-btn btn-delete" onclick="deleteEmail()">üóëÔ∏è Delete</button>
                            <button class="action-btn btn-report" onclick="reportEmail()">‚ö†Ô∏è Report</button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
        }
        
        function getRecommendations(riskLevel) {
            const recommendations = {
                high: `
                    <strong>‚õî Do NOT:</strong><br>
                    ‚Ä¢ Click any links in this email<br>
                    ‚Ä¢ Reply to this email<br>
                    ‚Ä¢ Download any attachments<br>
                    ‚Ä¢ Share any personal information<br><br>
                    <strong>‚úÖ Do:</strong><br>
                    ‚Ä¢ Delete this email immediately<br>
                    ‚Ä¢ Report it as phishing to your IT department<br>
                    ‚Ä¢ If it claims to be from a company you use, contact them directly using their official website
                `,
                medium: `
                    <strong>‚ö†Ô∏è Be Cautious:</strong><br>
                    ‚Ä¢ Verify the sender through another channel (call them directly)<br>
                    ‚Ä¢ Check the actual link destination before clicking (hover over links)<br>
                    ‚Ä¢ Look for other suspicious signs (urgency, grammar errors)<br>
                    ‚Ä¢ When in doubt, contact the sender using a known phone number or email
                `,
                low: `
                    <strong>‚úÖ Email appears legitimate, but:</strong><br>
                    ‚Ä¢ Still verify any requests for sensitive information<br>
                    ‚Ä¢ Check that links go to the expected website<br>
                    ‚Ä¢ Be cautious of unexpected attachments<br>
                    ‚Ä¢ If something feels off, trust your instincts and verify
                `
            };
            return recommendations[riskLevel] || recommendations.medium;
        }
        
        function getExplanation(result) {
            if (result.risk_level === 'high') {
                return `This email shows strong signs of being a phishing attempt. Multiple security checks failed, which means the sender is likely trying to impersonate someone else to steal your information or money.`;
            } else if (result.risk_level === 'medium') {
                return `This email has several suspicious indicators that suggest it might not be legitimate. The sender's domain or email configuration doesn't match what we'd expect from a trustworthy source.`;
            } else {
                return `This email passed most security checks, but it's always good to stay vigilant. Verify any unusual requests even from legitimate-looking emails.`;
            }
        }
        
        function analyzeTrustSignals(summary) {
            const good = [];
            const bad = [];
            
            summary.forEach(item => {
                const lowerItem = item.toLowerCase();
                // Identify negative signals
                if (lowerItem.includes('no mail server') || 
                    lowerItem.includes("doesn't match") || 
                    lowerItem.includes('no anti-spoofing') ||
                    lowerItem.includes('failed') ||
                    lowerItem.includes('suspicious') ||
                    lowerItem.includes('not found')) {
                    bad.push(item);
                } else {
                    // Positive signals
                    good.push(item);
                }
            });
            
            return { good, bad };
        }
        
        function deleteEmail() {
            if (confirm('Are you sure you want to delete this email?')) {
                Office.context.mailbox.item.deleteAsync((result) => {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        alert('Email deleted successfully');
                    } else {
                        alert('Could not delete email. Please delete it manually.');
                    }
                });
            }
        }
        
        function reportEmail() {
            alert('Please forward this email to your IT security team or report it through your organization\'s phishing report system.');
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>
